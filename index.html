<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulatore WindTre PRO+ - Ottobre 2025</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { box-sizing: border-box; }
  body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .slide-in { animation: slideIn 0.3s ease-out; }
  @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-orange-100 min-h-screen p-4">
<input type="file" id="file-upload" accept=".json" style="display: none;">
<div id="app" class="max-w-7xl mx-auto"></div>
<script>
// === CONFIGURAZIONE PDV ===
const pdvConfig = {
  strada: { name: 'Strada', clusters: [
    { mobile: [70,105,135,165], fisso: [28,46,67,80] },
    { mobile: [70,115,160,200], fisso: [34,60,83,97] },
    { mobile: [70,130,185,225], fisso: [39,67,96,108] }
  ]},
  cc: { name: 'Centro Commerciale', clusters: [
    { mobile: [80,115,160,205], fisso: [30,48,70,84] },
    { mobile: [80,120,185,225], fisso: [36,62,86,100] },
    { mobile: [80,135,205,245], fisso: [41,69,99,110] }
  ]}
};

// === STATE ===
let state = {
  config: {
    pdvType: 'cc',
    cluster: 1, // 0=1, 1=2, 2=3
    giorniLavorativi: 31,
    giorniTrascorsi: 7,
    rsMultipunto: 1,
    promoterPlus: false,
    promoter: false
  },
  vendite: JSON.parse(localStorage.getItem('windtre_vendite_v2') || '[]'),
  showForm: false,
  formData: {}
};

// === SALVATAGGIO ===
function saveState() {
  localStorage.setItem('windtre_vendite_v2', JSON.stringify(state.vendite));
  localStorage.setItem('windtre_config_v2', JSON.stringify(state.config));
}

// === CARICA CONFIG ===
function loadConfig() {
  const cfg = localStorage.getItem('windtre_config_v2');
  if (cfg) Object.assign(state.config, JSON.parse(cfg));
}

// === CALCOLI SOGLIE ===
function getSoglie(type, pdv, cluster) {
  return pdvConfig[pdv].clusters[cluster][type];
}

function calcolaSoglia(punti, soglie) {
  if (punti >= soglie[3]) return 4;
  if (punti >= soglie[2]) return 3;
  if (punti >= soglie[1]) return 2;
  if (punti >= soglie[0]) return 1;
  return 0;
}

// === PUNTI MOBILE ===
function puntiMobile(v) {
  let p = v.underground ? 0.5 : 1.0;
  if (v.mnp) p += 1.0;
  if (v.tipoGA === 'tied') p += (v.soglia >= 3 ? 2.25 : 2.0);
  if (v.tipoGA === 'piva') p += 1.0;
  if (v.mnp && ['iliad','fastweb','coop','poste','tiscali'].includes(v.operatore)) p += 1.0;
  if (v.piuSicuri !== 'no') p = p * 1.0; else p *= 0.75;
  if (v.tiedPhaseIn && v.mnp) p += 0.5;
  if (v.profStaffXL) p += 0.5;
  if (v.reloadExchange) p += 0.5;
  return p;
}

// === PUNTI FISSO ===
function puntiFisso(v) {
  let p = v.piva ? 1.5 : 1.0;
  if (v.secondaLinea) p += 1.5;
  if (v.fritzbox) p += 1.0;
  if (v.netflix !== 'no') p += 0.5;
  if (v.piuSicuriCasa) p += 0.25;
  if (v.assicurazione) p += 0.5;
  return p;
}

// === COMMISSIONI MOBILE ===
function commMobile(v, soglia) {
  let c = v.tipoGA === 'untied' ? 1 : 5;
  const molt = [0,1,1.5,2,2.25][soglia];
  c += parseFloat(v.canone||0) * (molt + (v.mnp?1:0) + (v.tipoGA==='tied'?2:0) + (v.tipoGA==='piva'?1:0));
  if (v.telefono) {
    if (v.fascia === '<200') c += 20;
    else if (v.fascia === '200-600') c += 25;
    else if (v.fascia === '>600') c += 40;
    if (v.findomestic) c += 15;
    if (v.compass) c += 20;
  }
  if (v.convergenza) c += 15;
  if (v.piuSicuri === 'pro') c += 5;
  if (v.reloadExchange) c += 5;
  return c;
}

// === ASSICURAZIONI ===
function commAssicurazione(v) {
  const base = 10;
  const canone = parseFloat(v.canone);
  let varBoost = 0;
  if (v.tipo === 'casa-start') varBoost = 2.5 * canone + 0.5 * canone;
  else if (v.tipo === 'casa-plus') varBoost = 2.5 * canone + 0.5 * canone;
  else if (v.tipo === 'casa-full') varBoost = 2.5 * canone + 0.5 * canone;
  else if (v.tipo === 'pet') varBoost = 2.5 * canone;
  else if (v.tipo === 'viaggi') varBoost = 2.5 * canone;
  else if (v.tipo === 'viaggio-mondo') varBoost = 0.125 * v.premio;
  else if (v.tipo === 'sport-ind') varBoost = 2.5 * canone;
  else if (v.tipo === 'elettrodom') varBoost = 1.5 * canone;
  else if (v.tipo === 'protezione-pro') varBoost = 2.0 * canone;
  return base + varBoost + (v.rinnovo ? canone : 0);
}

// === STATISTICHE ===
function calcolaTutto() {
  loadConfig();
  const cfg = state.config;
  const soglieM = getSoglie('mobile', cfg.pdvType, cfg.cluster);
  const soglieF = getSoglie('fisso', cfg.pdvType, cfg.cluster);

  const stats = {
    mobile: { count:0, piva:0, tied:0, punti:0, fatturato:0 },
    fisso: { count:0, punti:0, fatturato:0 },
    lucegas: { count:0, fatturato:0 },
    cb: { punti:0, eventi:0 },
    assicurazioni: { count:0, punti:0, fatturato:0 },
    extraPivaMobile: 0,
    extraPivaFisso: 0,
    extraCluster3: 0,
    extraSmartCB: 0,
    decurtazione: 0,
    totale: 0
  };

  // Assegna soglia temporanea
  state.vendite.forEach(v => {
    if (v.tipo === 'mobile') v.soglia = calcolaSoglia(stats.mobile.punti, soglieM);
    if (v.tipo === 'fisso') v.soglia = calcolaSoglia(stats.fisso.punti, soglieF);
  });

  // Ricalcola
  state.vendite.forEach(v => {
    if (v.tipo === 'mobile') {
      const p = puntiMobile(v);
      stats.mobile.punti += p;
      stats.mobile.count++;
      if (v.tipoGA === 'piva') stats.mobile.piva++;
      if (v.tipoGA === 'tied') stats.mobile.tied++;
      stats.mobile.fatturato += commMobile(v, calcolaSoglia(stats.mobile.punti, soglieM));
    }
    if (v.tipo === 'fisso') {
      const p = puntiFisso(v);
      stats.fisso.punti += p;
      stats.fisso.count++;
      stats.fisso.fatturato += 22 + 22 * [0,2,3,4,5][calcolaSoglia(stats.fisso.punti, soglieF)];
    }
    if (v.tipo === 'luceegas') {
      const c = v.micro ? (v.sdd ? 115 : 100) : (v.sdd ? 75 : 60);
      stats.lucegas.fatturato += c;
      stats.lucegas.count++;
    }
    if (v.tipo === 'assicurazione') {
      stats.assicurazioni.fatturato += commAssicurazione(v);
      stats.assicurazioni.count++;
      stats.assicurazioni.punti += v.punti || 0;
    }
    if (v.tipo === 'cb') {
      stats.cb.punti += v.punti;
      stats.cb.eventi++;
    }
  });

  // Extra P.IVA
  const promoter = cfg.promoterPlus ? 0 : cfg.promoter ? 1 : 2;
  if (stats.mobile.piva >= 65 && promoter === 0) stats.extraPivaMobile = 3700 + 20*(stats.mobile.piva-65);
  else if (stats.mobile.piva >= 48 && promoter <= 1) stats.extraPivaMobile = promoter === 0 ? 2600 + 20*(stats.mobile.piva-48) : 2600 + 20*(stats.mobile.piva-48);
  else if (stats.mobile.piva >= 35 && promoter === 2) stats.extraPivaMobile = 1200 + 20*(stats.mobile.piva-35);

  // Decurtazione
  const sogliaFMin = calcolaSoglia(stats.fisso.punti, soglieF);
  if (sogliaFMin < 1 || stats.mobile.piva < 8) {
    stats.decurtazione = (stats.mobile.fatturato + stats.fisso.fatturato) * 0.3;
  }

  // Totale
  stats.totale = stats.mobile.fatturato + stats.fisso.fatturato + stats.lucegas.fatturato + stats.assicurazioni.fatturato + stats.extraPivaMobile - stats.decurtazione;

  return { stats, soglieM, soglieF, sogliaFMin };
}

// === RENDER ===
function render() {
  const { stats } = calcolaTutto();
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-orange-600">Simulatore WindTre PRO+ - DRMS + CB</h1>
      <p class="text-gray-600">Ottobre 2025 - Completo</p>
      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
        <button onclick="state.showForm=true;state.formData={tipo:'mobile'};render()" class="bg-orange-500 text-white px-4 py-2 rounded">+ Mobile</button>
        <button onclick="state.showForm=true;state.formData={tipo:'fisso'};render()" class="bg-blue-500 text-white px-4 py-2 rounded">+ Fisso</button>
        <button onclick="state.showForm=true;state.formData={tipo:'luceegas'};render()" class="bg-green-500 text-white px-4 py-2 rounded">+ Luce&Gas</button>
        <button onclick="state.showForm=true;state.formData={tipo:'assicurazione'};render()" class="bg-purple-500 text-white px-4 py-2 rounded">+ Assicurazione</button>
      </div>
      <div class="mt-4 text-4xl font-bold text-green-600">€${stats.totale.toFixed(0)}</div>
    </div>
  `;
  if (state.showForm) renderForm();
  else renderDashboard(stats);
}

function renderForm() {
  // Form dettagliato per ogni tipo
}

function renderDashboard(stats) {
  document.getElementById('app').innerHTML += `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded shadow">
        <h3 class="font-bold">Mobile</h3>
        <p>${stats.mobile.count} att. | €${stats.mobile.fatturato.toFixed(0)}</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3 class="font-bold">Fisso</h3>
        <p>${stats.fisso.count} att. | €${stats.fisso.fatturato.toFixed(0)}</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3 class="font-bold">Extra P.IVA</h3>
        <p>€${stats.extraPivaMobile}</p>
      </div>
    </div>
  `;
}

// === INIT ===
loadConfig();
render();
</script>
</body>
</html>
